<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Galeria Anônima</title>
  <!-- Supabase CDN (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0a0a0a;
      --panel:#121212;
      --muted:#8a8a8a;
      --accent:#bdbdbd;
      --glass: rgba(255,255,255,0.03);
      --radius:10px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--accent);font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{
      max-width:1100px;margin:28px auto;padding:20px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius:14px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.6);
      min-height:80vh;
    }
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:20px;color:#fff}
    .controls{display:flex;gap:12px;align-items:center}
    .search{
      background:var(--panel);border:1px solid rgba(255,255,255,0.04);
      padding:8px 12px;border-radius:8px;color:var(--accent);min-width:220px;
    }
    .uploader{
      display:flex;gap:8px;align-items:center;
    }
    input[type="file"]{display:none}
    .btn{
      background:#222;border:1px solid rgba(255,255,255,0.04);color:var(--accent);
      padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600
    }
    .btn:active{transform:translateY(1px)}
    .meta{display:flex;gap:8px;align-items:center}
    .input-name{
      background:transparent;border:1px dashed rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--accent);
      min-width:180px;
    }

    main{margin-top:14px}
    .grid{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;
    }
    .card{
      background:var(--glass);border-radius:10px;padding:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);
      display:flex;flex-direction:column;gap:8px;
    }
    .thumb{
      background:#000;border-radius:6px;min-height:130px;display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .thumb img, .thumb video{width:100%;height:100%;object-fit:cover;display:block}
    .name{font-size:14px;color:#fff;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .sub{font-size:12px;color:var(--muted)}
    .actions{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
    .small{font-size:12px;color:var(--muted)}
    .notice{font-size:13px;color:var(--muted);margin-top:8px}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    @media(max-width:520px){
      .controls{flex-direction:column;align-items:stretch}
      header{align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Galeria Anônima</h1>
        <div class="notice">Envie imagens / GIFs / vídeos. Não precisa de conta. Pesquise por nome.</div>
      </div>

      <div class="controls">
        <input id="search" class="search" placeholder="Pesquisar por nome..." />
        <div class="uploader">
          <input id="file" type="file" accept="image/*,video/*,image/gif" />
          <label for="file" class="btn">Escolher arquivo</label>
          <input id="name" class="input-name" placeholder="Nome do arquivo (obrigatório)" />
          <button id="uploadBtn" class="btn">Enviar</button>
        </div>
      </div>
    </header>

    <main>
      <div id="status" class="small"></div>
      <div id="gallery" class="grid"></div>
    </main>

    <footer>
      Feito com Supabase • Tema preto/cinza • ⚠️ Não hospede chaves secretas no cliente.
    </footer>
  </div>

  <script>
    /*******************************
     * CONFIGURE AQUI (obrigatório)
     *******************************/
    const SUPABASE_URL = "https://zmczgjkuqczobdwiytii.supabase.co"; // <- coloque sua URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptY3pnamt1cWN6b2Jkd2l5dGlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxOTExOTIsImV4cCI6MjA3Mjc2NzE5Mn0.xvD1wRRy8dJ7V_c0gFC3CA9yHLB7AJIHLEMfnjTYY-0"; // <- coloque sua anon key

    // Inicializa cliente Supabase (correto agora)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const BUCKET = "uploads";

    const fileInput = document.getElementById("file");
    const nameInput = document.getElementById("name");
    const uploadBtn = document.getElementById("uploadBtn");
    const galleryEl = document.getElementById("gallery");
    const statusEl = document.getElementById("status");
    const searchEl = document.getElementById("search");

    // carregar gallery ao abrir
    fetchAndRender();

    uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      const title = nameInput.value && nameInput.value.trim();
      if (!file) return alert("Escolha um arquivo para enviar.");
      if (!title) return alert("Coloque um nome para poder pesquisar depois.");

      setStatus("Enviando...");

      try {
        const path = `${Date.now()}_${sanitize(file.name)}`;

        const { error: uploadError } = await supabase
          .storage
          .from(BUCKET)
          .upload(path, file, { cacheControl: "3600", upsert: false, contentType: file.type });

        if (uploadError) throw uploadError;

        const { data: publicData } = supabase
          .storage
          .from(BUCKET)
          .getPublicUrl(path);

        const publicUrl = publicData?.publicUrl || null;

        const { error: insertError } = await supabase
          .from("posts")
          .insert({
            name: title,
            path: path,
            content_type: file.type,
            public_url: publicUrl
          });

        if (insertError) throw insertError;

        fileInput.value = "";
        nameInput.value = "";
        setStatus("Enviado com sucesso ✅");
        await fetchAndRender();
      } catch (err) {
        setStatus("Erro: " + (err.message || JSON.stringify(err)));
      }
    });

    searchEl.addEventListener("input", debounce(() => fetchAndRender(), 300));

    async function fetchAndRender(){
      setStatus("Carregando...");
      const q = searchEl.value.trim();

      try {
        let { data, error } = await supabase
          .from("posts")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) throw error;
        if (q) {
          const qLower = q.toLowerCase();
          data = data.filter(p => (p.name || "").toLowerCase().includes(qLower));
        }

        renderGallery(data || []);
        setStatus(`Mostrando ${ (data||[]).length } item(s).`);
      } catch (err) {
        setStatus("Erro ao buscar: " + (err.message || JSON.stringify(err)));
      }
    }

    function renderGallery(items){
      galleryEl.innerHTML = "";
      if (!items.length) {
        galleryEl.innerHTML = '<div style="color:var(--muted)">Sem uploads ainda.</div>';
        return;
      }

      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        const thumb = document.createElement("div");
        thumb.className = "thumb";

        if ((item.content_type||"").startsWith("video")) {
          const v = document.createElement("video");
          v.src = item.public_url || buildUrl(item.path);
          v.controls = true;
          v.preload = "metadata";
          thumb.appendChild(v);
        } else {
          const img = document.createElement("img");
          img.src = item.public_url || buildUrl(item.path);
          img.alt = item.name || "sem nome";
          thumb.appendChild(img);
        }

        const nameEl = document.createElement("div");
        nameEl.className = "name";
        nameEl.textContent = item.name || "—";

        const sub = document.createElement("div");
        sub.className = "sub";
        const created = item.created_at ? new Date(item.created_at).toLocaleString() : "";
        sub.textContent = `${item.content_type || ""} · ${created}`;

        card.appendChild(thumb);
        card.appendChild(nameEl);
        card.appendChild(sub);

        galleryEl.appendChild(card);
      });
    }

    function buildUrl(path){
      if(!path) return "";
      const base = SUPABASE_URL.replace(/\/$/,"");
      return `${base}/storage/v1/object/public/${BUCKET}/${encodeURIComponent(path)}`;
    }

    function setStatus(t){ statusEl.textContent = t; }

    function sanitize(s){ return s.replace(/\s+/g, "_").replace(/[^a-zA-Z0-9._-]/g, "") }

    function debounce(fn, wait=200){
      let t;
      return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait) }
    }
  </script>
</body>
</html>
